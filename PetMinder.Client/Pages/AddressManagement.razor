@page "/profile/addresses"
@using PetMinder.Models
@using System
@inject AddressService AddressService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<PageTitle>Manage My Addresses</PageTitle>

<div class="min-h-screen bg-slate-50 text-slate-900 py-10 px-4">
    <div class="max-w-2xl mx-auto">
        
        <button @onclick="GoBack" class="mb-6 flex items-center text-sm font-medium text-slate-500 hover:text-emerald-600 transition-colors">
            <Heroicon Name="@HeroiconName.ArrowLeft" Type="@HeroiconType.Outline" class="mr-2 h-4 w-4" />
            Back to Profile
        </button>

        <div class="mb-6">
            <h1 class="text-3xl font-bold tracking-tight text-slate-900 flex items-center gap-3">
                <Heroicon Name="@HeroiconName.MapPin" Type="@HeroiconType.Solid" class="h-8 w-8 text-emerald-500" />
                Manage My Addresses
            </h1>
            <p class="text-sm text-slate-500 mt-1">Your primary address is used to calculate distances to sitters.</p>
        </div>

        <h2 class="text-xl font-semibold text-slate-900 mb-4">My Current Addresses</h2>

        @if (isLoading)
        {
            <div class="flex flex-col items-center py-10 text-slate-500">
                <div class="h-6 w-6 animate-spin rounded-full border-2 border-emerald-500 border-t-transparent"></div>
                <p class="mt-2 text-sm">Loading addresses...</p>
            </div>
        }
        else if (!addresses.Any())
        {
            <div class="flex flex-col items-center justify-center rounded-3xl border border-dashed border-slate-300 bg-slate-50 py-12 text-center">
                <div class="mb-3 rounded-full bg-slate-100 p-3 text-slate-400">
                    <Heroicon Name="@HeroiconName.Home" Type="@HeroiconType.Outline" class="h-8 w-8" />
                </div>
                <p class="text-sm text-slate-500">You have no addresses saved. Add one below.</p>
            </div>
        }
        else
        {
            <ul class="space-y-3">
                @foreach (var address in addresses.OrderBy(a => a.Type))
                {
                    <li class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-4 shadow-sm transition hover:shadow-md">
                        <div class="flex items-start gap-3">
                            <div class="mt-1 text-slate-400">
                                @if (address.Type == AddressType.Primary)
                                {
                                    <Heroicon Name="@HeroiconName.Home" Type="@HeroiconType.Solid" class="h-5 w-5 text-emerald-500" />
                                }
                                else
                                {
                                    <Heroicon Name="@HeroiconName.MapPin" Type="@HeroiconType.Outline" class="h-5 w-5" />
                                }
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-slate-900">
                                    @address.Street, @address.ZipCode @address.City
                                </div>
                                <div class="mt-1">
                                    @if (address.Type == AddressType.Primary)
                                    {
                                        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-0.5 text-xs font-medium text-emerald-700 ring-1 ring-emerald-600/20">
                                            <Heroicon Name="@HeroiconName.Star" Type="@HeroiconType.Solid" class="h-3 w-3" />
                                            Primary
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 ring-1 ring-slate-500/10">
                                            Secondary
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                        <button
                            class="inline-flex items-center gap-1.5 rounded-lg bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-700 shadow-sm hover:bg-rose-100 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-offset-1 transition-colors"
                            @onclick="() => DeleteAddress(address.UserAddressId)">
                            <Heroicon Name="@HeroiconName.Trash" Type="@HeroiconType.Outline" class="h-3.5 w-3.5" />
                            Delete
                        </button>
                    </li>
                }
            </ul>
        }

        <hr class="my-8 border-slate-200" />

        <h2 class="text-xl font-semibold text-slate-900 mb-4">Add New Address</h2>

        <EditForm Model="newAddress" OnValidSubmit="HandleAddAddress" class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-sm text-rose-600 mb-4" />

            @if (!string.IsNullOrEmpty(formErrorMessage))
            {
                <div class="mb-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                    @formErrorMessage
                </div>
            }

            <div class="space-y-4">
                <div>
                    <label for="street" class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1">Street</label>
                    <InputText id="street" class="block w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" @bind-Value="newAddress.Street" />
                    <ValidationMessage For="@(() => newAddress.Street)" class="text-xs text-rose-500 mt-1" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label for="city" class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1">City</label>
                        <InputText id="city" class="block w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" @bind-Value="newAddress.City" />
                        <ValidationMessage For="@(() => newAddress.City)" class="text-xs text-rose-500 mt-1" />
                    </div>
                    <div>
                        <label for="zipcode" class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1">Postal Code</label>
                        <InputText id="zipcode" class="block w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" @bind-Value="newAddress.ZipCode" />
                        <ValidationMessage For="@(() => newAddress.ZipCode)" class="text-xs text-rose-500 mt-1" />
                    </div>
                </div>

                <div>
                    <label for="type" class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1">Address Type</label>
                    <InputSelect id="type" class="block w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" @bind-Value="newAddress.Type">
                        @foreach (var type in Enum.GetValues<AddressType>())
                        {
                            <option value="@type">@type</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <div class="mt-6">
                <button type="submit"
                        class="inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-emerald-300 w-full sm:w-auto"
                        disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="mr-2 inline-block h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <Heroicon Name="@HeroiconName.Plus" Type="@HeroiconType.Solid" class="h-4 w-4" />
                        <span>Add Address</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private List<AddressDTO> addresses = new();
    private CreateAddressDTO newAddress = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string? formErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadAddresses();
    }

    private async Task LoadAddresses()
    {
        isLoading = true;
        addresses = await AddressService.GetUserAddressesAsync();
        isLoading = false;
    }

    private async Task HandleAddAddress()
    {
        isSubmitting = true;
        formErrorMessage = null;

        var result = await AddressService.AddAddressAsync(newAddress);

        if (result.IsSuccess)
        {
            newAddress = new();
            await LoadAddresses();
        }
        else
        {
            formErrorMessage = result.ErrorMessage ?? "Failed to add address.";
        }
        isSubmitting = false;
    }

    private async Task DeleteAddress(long userAddressId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this address?");
        if (confirmed)
        {
            var success = await AddressService.DeleteAddressAsync(userAddressId);
            if (success)
            {
                await LoadAddresses();
            }
            else
            {
                formErrorMessage = "Failed to delete address.";
            }
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/profile");
    }
}