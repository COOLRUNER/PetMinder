@page "/profile"
@using PetMinder.Shared.DTO
@using PetMinder.Models
@inject PetMinder.Client.Services.AuthService AuthService
@inject PetMinder.Client.Services.SitterProfileService SitterProfileService
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration

<PageTitle>My Profile</PageTitle>

<div class="min-h-screen bg-slate-50 text-slate-900 py-10 px-4">
    <div class="max-w-6xl mx-auto">


        
        @if (isLoading)
        {
            <div class="flex flex-col items-center justify-center py-20 text-slate-500">
                <div class="h-8 w-8 animate-spin rounded-full border-2 border-emerald-500 border-t-transparent"></div>
                <p class="mt-4 text-sm font-medium">Loading your profile...</p>
            </div>
        }
        else if (profile == null)
        {
            <div class="rounded-2xl border border-rose-200 bg-rose-50 p-6 text-center text-rose-800">
                <p>Unable to load profile data. Please try logging in again.</p>
            </div>
        }
        else
        {
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">

                <div class="md:col-span-4 space-y-6">

                    <div class="rounded-3xl border border-slate-200 bg-white p-8 text-center shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-emerald-50 to-white opacity-50"></div>

                        <div class="relative mx-auto mb-4 h-32 w-32">
                            <div class="h-full w-full overflow-hidden rounded-full ring-4 ring-white shadow-lg bg-slate-100 flex items-center justify-center">
                                @if (!string.IsNullOrWhiteSpace(profile.ProfilePhotoUrl))
                                {
                                    <img src="@GetPhotoUrl(profile.ProfilePhotoUrl)" alt="@profile.FirstName" class="h-full w-full object-cover" />
                                }
                                else
                                {
                                    <Heroicon Name="@HeroiconName.User" Type="@HeroiconType.Solid" class="w-16 h-16 text-slate-300" />
                                }
                            </div>
                            @if (IsFullyVerified)
                            {
                                <div class="absolute bottom-1 right-1 h-8 w-8 rounded-full bg-emerald-500 ring-2 ring-white flex items-center justify-center text-white shadow-sm" title="Fully Verified">
                                    <Heroicon Name="@HeroiconName.CheckBadge" Type="@HeroiconType.Solid" class="w-5 h-5" />
                                </div>
                            }
                        </div>

                        <h1 class="text-2xl font-bold text-slate-900">@profile.FirstName @profile.LastName</h1>

                        <div class="mt-3 flex flex-wrap justify-center gap-2">
                            @if (profile.Roles != null)
                            {
                                @foreach (var role in profile.Roles)
                                {
                                    var isSitter = role == "Sitter";
                                    var isVerified = isSitter && profile.IsVerified;
                                    var badgeColor = isVerified ? "bg-emerald-100 text-emerald-800 border-emerald-200" : "bg-slate-100 text-slate-700 border-slate-200";

                                    <span class="inline-flex items-center gap-1.5 rounded-full border px-3 py-1 text-xs font-semibold @badgeColor">
                                        @if(isVerified) {
                                            <Heroicon Name="@HeroiconName.ShieldCheck" Type="@HeroiconType.Solid" class="w-3.5 h-3.5" />
                                        }
                                        @role
                                    </span>
                                }
                            }
                        </div>

                        <div class="mt-4 space-y-2 border-t border-slate-100 pt-4">
                            @if (profile.Roles != null && profile.Roles.Contains("Sitter"))
                            {
                                <div class="flex items-center justify-center gap-2 text-sm" title="Rating as a Sitter">
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 w-12 text-right">Sitter</span>
                                    <Heroicon Name="@HeroiconName.Star" Type="@HeroiconType.Solid" class="h-4 w-4 text-amber-400" />
                                    <span class="font-bold text-slate-900">@profile.AverageRating.ToString("F1")</span>
                                    <span class="text-slate-500 text-xs">(@profile.ReviewCount)</span>
                                </div>
                            }
                            
                            <div class="flex items-center justify-center gap-2 text-sm" title="Rating as an Owner">
                                <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 w-12 text-right">Owner</span>
                                <Heroicon Name="@HeroiconName.Star" Type="@HeroiconType.Solid" class="h-4 w-4 text-sky-400" />
                                <span class="font-bold text-slate-900">@profile.AverageOwnerRating.ToString("F1")</span>
                                <span class="text-slate-500 text-xs">(@profile.OwnerReviewCount)</span>
                            </div>
                        </div>

                        <button @onclick="GoToEdit" class="mt-6 w-full inline-flex items-center justify-center gap-2 rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-900 focus:ring-offset-2">
                            <Heroicon Name="@HeroiconName.PencilSquare" Type="@HeroiconType.Outline" class="w-4 h-4" />
                            Edit Profile
                        </button>
                    </div>

                    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                        <h3 class="mb-4 text-xs font-bold uppercase tracking-wide text-slate-500">Trust & Verification</h3>
                        <ul class="space-y-4">
                            <li class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-500">
                                        <Heroicon Name="@HeroiconName.Envelope" Type="@HeroiconType.Outline" class="w-4 h-4" />
                                    </div>
                                    <span class="text-sm font-medium text-slate-700">Email</span>
                                </div>
                                @if (completedSteps.Contains(VerificationStep.EmailVerification))
                                {
                                    <span class="text-emerald-500">
                                        <Heroicon Name="@HeroiconName.CheckCircle" Type="@HeroiconType.Solid" class="w-5 h-5" />
                                    </span>
                                }
                                else
                                {
                                    <button @onclick="SendVerificationEmail"
                                            disabled="@sendingEmail"
                                            class="inline-flex items-center rounded-lg bg-emerald-50 px-3 py-1.5 text-xs font-semibold text-emerald-700 ring-1 ring-inset ring-emerald-600/20 hover:bg-emerald-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        @(sendingEmail ? "Sending..." : "Verify Now")
                                    </button>
                                }
                            </li>

                            <li class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-500">
                                        <Heroicon Name="@HeroiconName.Camera" Type="@HeroiconType.Outline" class="w-4 h-4" />
                                    </div>
                                    <span class="text-sm font-medium text-slate-700">Photo</span>
                                </div>
                                @if (completedSteps.Contains(VerificationStep.ProfilePhotoUpload))
                                {
                                    <span class="text-emerald-500">
                                        <Heroicon Name="@HeroiconName.CheckCircle" Type="@HeroiconType.Solid" class="w-5 h-5" />
                                    </span>
                                }
                                else
                                {
                                    <button @onclick="GoToEdit"
                                            class="inline-flex items-center rounded-lg bg-emerald-50 px-3 py-1.5 text-xs font-semibold text-emerald-700 ring-1 ring-inset ring-emerald-600/20 hover:bg-emerald-100 transition-colors">
                                        Upload Photo
                                    </button>
                                }
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="md:col-span-8 space-y-6">

                    @if (IsFullyVerified)
                    {
                        <div class="rounded-3xl border border-emerald-200 bg-emerald-50 p-6 shadow-sm">
                            <div class="flex items-center gap-3 mb-3 text-emerald-800">
                                <Heroicon Name="@HeroiconName.Sparkles" Type="@HeroiconType.Solid" class="w-6 h-6 animate-pulse" />
                                <h2 class="text-lg font-bold">You're Fully Verified!</h2>
                            </div>
                            <p class="text-sm text-emerald-700 mb-4">You've unlocked full access as both an <strong>Owner</strong> and a <strong>Sitter</strong>. Here are your next steps:</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="rounded-2xl bg-white p-4 shadow-sm border border-emerald-100 flex flex-col items-start">
                                    <h3 class="text-sm font-bold text-slate-900 mb-1 leading-none flex items-center gap-1.5">
                                        <Heroicon Name="@HeroiconName.Heart" Type="@HeroiconType.Solid" class="w-3.5 h-3.5 text-rose-500" />
                                        As an Owner
                                    </h3>
                                    <p class="text-[0.7rem] text-slate-500 mb-3 flex-1">Add your furry friends to start booking sitters.</p>
                                    <button @onclick="GoToPets" class="text-[0.7rem] font-bold text-emerald-600 hover:text-emerald-500 transition-colors uppercase tracking-wider">Add Pets →</button>
                                </div>
                                <div class="rounded-2xl bg-white p-4 shadow-sm border border-emerald-100 flex flex-col items-start">
                                    <h3 class="text-sm font-bold text-slate-900 mb-1 leading-none flex items-center gap-1.5">
                                        <Heroicon Name="@HeroiconName.Briefcase" Type="@HeroiconType.Solid" class="w-3.5 h-3.5 text-sky-500" />
                                        As a Sitter
                                    </h3>
                                    <p class="text-[0.7rem] text-slate-500 mb-3 flex-1">Set your rates and availability to get discovered.</p>
                                    <button @onclick="GoToSitterSettings" class="text-[0.7rem] font-bold text-emerald-600 hover:text-emerald-500 transition-colors uppercase tracking-wider">Setup Profile →</button>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                        <h2 class="mb-4 text-lg font-bold text-slate-900">Contact Details</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="rounded-2xl bg-slate-50 p-4 border border-slate-100">
                                <span class="block text-xs font-bold uppercase tracking-wide text-slate-400">Email</span>
                                <span class="mt-1 block font-medium text-slate-900 break-all">@profile.Email</span>
                            </div>
                            <div class="rounded-2xl bg-slate-50 p-4 border border-slate-100">
                                <span class="block text-xs font-bold uppercase tracking-wide text-slate-400">Phone</span>
                                <span class="mt-1 block font-medium text-slate-900">
                                    @(string.IsNullOrEmpty(profile.Phone) ? "Not provided" : profile.Phone)
                                </span>
                            </div>
                        </div>
                    </div>

                    @if (profile.Roles != null && profile.Roles.Contains("Sitter"))
                    {
                        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                            <div class="mb-4 flex items-center justify-between">
                                <h2 class="text-lg font-bold text-slate-900">Credentials</h2>
                                <button @onclick="GoToEdit" class="text-xs font-semibold text-emerald-600 hover:text-emerald-500 hover:underline">
                                    Manage
                                </button>
                            </div>

                            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                                <div>
                                    <h3 class="mb-3 text-sm font-semibold text-slate-700">Qualifications</h3>
                                    @if (qualifications != null && qualifications.Any())
                                    {
                                        <div class="flex flex-wrap gap-2">
                                            @foreach (var q in qualifications)
                                            {
                                                <span class="inline-flex items-center gap-1.5 rounded-lg bg-emerald-50 px-3 py-1.5 text-xs font-medium text-emerald-700 ring-1 ring-inset ring-emerald-600/20" title="@q.QualificationType.Description">
                                                    <Heroicon Name="@HeroiconName.AcademicCap" Type="@HeroiconType.Solid" class="w-3.5 h-3.5" />
                                                    @q.QualificationType.Name
                                                </span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-xs text-slate-400 italic">No qualifications added.</p>
                                    }
                                </div>

                                <div>
                                    <h3 class="mb-3 text-sm font-semibold text-slate-700">Restrictions</h3>
                                    @if (restrictions != null && restrictions.Any())
                                    {
                                        <div class="flex flex-wrap gap-2">
                                            @foreach (var r in restrictions)
                                            {
                                                <span class="inline-flex items-center gap-1.5 rounded-lg bg-rose-50 px-3 py-1.5 text-xs font-medium text-rose-700 ring-1 ring-inset ring-rose-600/20" title="@r.RestrictionType.Description">
                                                    <Heroicon Name="@HeroiconName.NoSymbol" Type="@HeroiconType.Solid" class="w-3.5 h-3.5" />
                                                    @r.RestrictionType.Name
                                                </span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-xs text-slate-400 italic">No restrictions set.</p>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    
                    @if (profile.Badges != null && profile.Badges.Any())
                    {
                        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                            <h2 class="mb-4 text-lg font-bold text-slate-900">Badges</h2>
                            <div class="flex flex-wrap gap-4">
                                @foreach (var badge in profile.Badges)
                                {
                                    <div class="flex flex-col items-center p-2 rounded-xl border border-slate-100 bg-slate-50 min-w-[80px]" title="@badge.Description">
                                        <div class="h-10 w-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-500 shadow-sm">
                                           <Heroicon Name="@HeroiconName.Trophy" Type="@HeroiconType.Solid" class="w-6 h-6" />
                                        </div>
                                        <span class="text-[0.65rem] font-bold text-slate-700 mt-2 text-center text-balance leading-tight">@badge.Name</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                             <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500">
                                <Heroicon Name="@HeroiconName.Gift" Type="@HeroiconType.Solid" class="w-5 h-5" />
                             </div>
                             <h2 class="text-lg font-bold text-slate-900">Refer & Earn</h2>
                        </div>
                        
                        <div class="mb-4 bg-gradient-to-r from-indigo-50 to-white rounded-xl p-4 border border-indigo-100">
                            <p class="text-sm text-slate-700 mb-3">Invite friends and earn <span class="font-bold text-emerald-600">500 points</span> when they complete their first booking!</p>
                            
                            <div class="flex items-center gap-2 bg-white rounded-lg border border-slate-200 p-2 shadow-sm">
                                <code class="flex-1 font-mono font-bold text-slate-900 text-center tracking-wider text-lg">
                                    @(profile.ReferralCode ?? "Generating...")
                                </code>
                                <button class="rounded-md bg-slate-100 p-2 text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition-colors" title="Copy Code">
                                    <Heroicon Name="@HeroiconName.Clipboard" Type="@HeroiconType.Outline" class="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs text-slate-500 px-1">
                            <span>Your Referrals</span>
                            <span class="font-bold text-slate-900">@profile.ReferralsCount friends joined</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <button @onclick="GoToAddresses" class="group relative flex flex-col items-start overflow-hidden rounded-3xl border border-slate-200 bg-white p-6 text-left shadow-sm transition hover:border-emerald-300 hover:shadow-md hover:-translate-y-0.5">
                            <div class="mb-3 flex h-10 w-10 items-center justify-center rounded-full bg-sky-100 text-sky-600 group-hover:bg-sky-100 transition-colors">
                                <Heroicon Name="@HeroiconName.MapPin" Type="@HeroiconType.Outline" class="w-6 h-6" />
                            </div>
                            <h3 class="text-base font-bold text-slate-900">My Addresses</h3>
                            <p class="mt-1 text-xs text-slate-500">Manage your home locations.</p>
                            <div class="mt-4 inline-flex items-center text-xs font-semibold text-sky-600 group-hover:text-sky-500">
                                Manage →
                            </div>
                        </button>

                        <button @onclick="GoToNotifications" class="group relative flex flex-col items-start overflow-hidden rounded-3xl border border-slate-200 bg-white p-6 text-left shadow-sm transition hover:border-emerald-300 hover:shadow-md hover:-translate-y-0.5">
                            <div class="mb-3 flex h-10 w-10 items-center justify-center rounded-full bg-amber-100 text-amber-600 group-hover:bg-amber-100 transition-colors">
                                <Heroicon Name="@HeroiconName.Bell" Type="@HeroiconType.Outline" class="w-6 h-6" />
                            </div>
                            <h3 class="text-base font-bold text-slate-900">Notifications</h3>
                            <p class="mt-1 text-xs text-slate-500">Manage your alert preferences.</p>
                            <div class="mt-4 inline-flex items-center text-xs font-semibold text-amber-600 group-hover:text-amber-500">
                                Settings →
                            </div>
                        </button>

                        <button @onclick="GoToTransactions" class="group relative flex flex-col items-start overflow-hidden rounded-3xl border border-slate-200 bg-white p-6 text-left shadow-sm transition hover:border-emerald-300 hover:shadow-md hover:-translate-y-0.5">
                            <div class="mb-3 flex h-10 w-10 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 group-hover:bg-emerald-100 transition-colors">
                                <Heroicon Name="@HeroiconName.Banknotes" Type="@HeroiconType.Outline" class="w-6 h-6" />
                            </div>
                            <h3 class="text-base font-bold text-slate-900">Transactions</h3>
                            <p class="mt-1 text-xs text-slate-500">View point earnings and history.</p>
                            <div class="mt-4 inline-flex items-center text-xs font-semibold text-emerald-600 group-hover:text-emerald-500">
                                History →
                            </div>
                        </button>
                    </div>


                    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                        <h2 class="mb-4 text-lg font-bold text-slate-900">Recent Reviews</h2>
                        <ReviewList Reviews="@profile.RecentReviews" />
                    </div>

                </div>
            </div>
        }
    </div>
</div>

@code {
    private bool isLoading = true;
    private bool sendingEmail = false;
    private UserProfileDTO? profile;
    private HashSet<VerificationStep> completedSteps = new();
    private List<SitterQualificationDTO>? qualifications;
    private List<SitterRestrictionDTO>? restrictions;

    private bool IsFullyVerified =>
        completedSteps.Contains(VerificationStep.EmailVerification) &&
        completedSteps.Contains(VerificationStep.ProfilePhotoUpload) &&
        completedSteps.Contains(VerificationStep.IdentityVerification);

    protected override async Task OnInitializedAsync() => await LoadAllData();

    private async Task LoadAllData()
    {
        try
        {
            isLoading = true;
            profile = await AuthService.GetUserProfileAsync();

            if (profile != null)
            {
                var steps = await AuthService.GetVerificationStatusAsync();
                completedSteps = steps?.ToHashSet() ?? new HashSet<VerificationStep>();

                if (profile.Roles != null && profile.Roles.Contains("Sitter"))
                {
                    try
                    {
                        var qualsTask = SitterProfileService.GetMyQualificationsAsync();
                        var restrTask = SitterProfileService.GetMyRestrictionsAsync();
                        await Task.WhenAll(qualsTask, restrTask);
                        qualifications = await qualsTask ?? new();
                        restrictions = await restrTask ?? new();
                    }
                    catch (Exception ex) when (ex.Message.Contains("403") || ex.Message.Contains("Forbidden"))
                    {
                        var refreshed = await AuthService.RefreshTokenAsync();
                        if (refreshed != null)
                        {
                            qualifications = await SitterProfileService.GetMyQualificationsAsync() ?? new();
                            restrictions = await SitterProfileService.GetMyRestrictionsAsync() ?? new();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SendVerificationEmail()
    {
        sendingEmail = true;
        var success = await AuthService.SendVerificationEmailAsync();
        sendingEmail = false;
    }

    private void GoToEdit() => NavigationManager.NavigateTo("/profile/edit");
    private void GoToAddresses() => NavigationManager.NavigateTo("/profile/addresses");
    private void GoToNotifications() => NavigationManager.NavigateTo("/profile/notifications");
    private void GoToTransactions() => NavigationManager.NavigateTo("/transactions");
    private void GoToPets() => NavigationManager.NavigateTo("/pets");
    private void GoToSitterSettings() => NavigationManager.NavigateTo("/sitter/settings");


    private string GetPhotoUrl(string? photoUrl)
    {
        if (string.IsNullOrEmpty(photoUrl))
            return string.Empty;

        if (photoUrl.StartsWith("http"))
            return photoUrl;
            
        var backendUrl = Configuration["BackendUrl"] ?? "https://localhost:7185";
        return $"{backendUrl.TrimEnd('/')}{photoUrl}";
    }
}