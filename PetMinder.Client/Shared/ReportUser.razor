@using PetMinder.Shared.DTO
@using PetMinder.Client.Services
@inject AuthService AuthService
@inject IJSRuntime JS

@if (IsVisible)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @onclick="Close"></div>

        <div class="relative w-full max-w-md transform overflow-hidden rounded-3xl bg-white shadow-2xl transition-all animate-in fade-in zoom-in duration-200">
            <div class="border-b border-slate-100 bg-rose-50/50 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-rose-700 flex items-center gap-2">
                    <Heroicon Name="@HeroiconName.ExclamationTriangle" Type="@HeroiconType.Solid" class="h-5 w-5" />
                    Report User
                </h3>
                <button @onclick="Close" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <Heroicon Name="@HeroiconName.XMark" Type="@HeroiconType.Solid" class="h-6 w-6" />
                </button>
            </div>

            <div class="p-6">
                <p class="mb-4 text-sm text-slate-600">
                    We take safety seriously. Please describe why you are reporting 
                    <strong class="text-slate-900">@ReportedUserName</strong>.
                </p>

                <textarea @bind="reason"
                          class="w-full h-32 rounded-xl border-slate-200 bg-slate-50 text-sm p-3 focus:ring-2 focus:ring-rose-500/20 focus:border-rose-500 outline-none resize-none placeholder:text-slate-400"
                          placeholder="Please provide details (e.g. suspicious behavior, offensive language, spam)..."></textarea>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="mt-3 text-xs text-rose-600 font-medium">@errorMessage</div>
                }
            </div>

            <div class="flex items-center justify-end gap-3 border-t border-slate-100 bg-slate-50 px-6 py-4">
                <button class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50"
                        @onclick="Close" disabled="@isSubmitting">
                    Cancel
                </button>
                <button class="inline-flex items-center gap-2 rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-rose-500 disabled:opacity-70"
                        @onclick="SubmitReport" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="h-3 w-3 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
                        <span>Sending...</span>
                    }
                    else
                    {
                        <span>Submit Report</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public long ReportedUserId { get; set; }
    [Parameter] public string ReportedUserName { get; set; } = "this user";
    [Parameter] public string Source { get; set; } = "Profile"; 

    private string reason = "";
    private bool isSubmitting = false;
    private string? errorMessage;

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
        reason = "";
        errorMessage = null;
    }

    private async Task SubmitReport()
    {
        if (string.IsNullOrWhiteSpace(reason) || reason.Length < 5)
        {
            errorMessage = "Please provide a reason (at least 5 characters).";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        var dto = new ReportUserDTO
        {
            ReportedUserId = ReportedUserId,
            Reason = reason,
            Source = Source
        };

        var result = await AuthService.ReportUserAsync(dto);

        if (result.Success)
        {
            await JS.InvokeVoidAsync("alert", "Report submitted. Thank you for keeping our community safe.");
            await Close();
        }
        else
        {
            errorMessage = result.Message; 
        }

        isSubmitting = false;
    }
}